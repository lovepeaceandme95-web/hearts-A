<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>hearts A · Boss</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      /* 主题切换到 #8b3d3d 红棕系 */
      --theme: #8b3d3d;       /* 指定主色 */
      --bg: #2b2222;          /* 深背景（与主题协调） */
      --panel: #332626;       /* 面板底色（深） */
      --text: #f7f2f2;        /* 文字高对比（微暖白） */
      --sub: #e1d3d3;         /* 次级文字（暖灰） */
      --accent: #8b3d3d;      /* 主色：你的指定色 */
      --accent-2: #b66565;    /* 主色的浅亮版用于高光 */
      --danger: #ff6b8f;      /* 危险色保留，红系兼容 */
      --shadow: 0 18px 48px rgba(0,0,0,.40);
      --radius: 16px;
      --border: #4a3636;      /* 深色描边（红棕） */
      --name-chip: #f0e2e2;   /* 浅暖灰（未用到但保留） */
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      padding: 28px;
      position: relative;
    }
    /* 深色氛围叠加（改为红系主导，辅以橙红） */
    body::after {
      content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background:
        radial-gradient(50% 80% at 50% -10%, color-mix(in srgb, var(--accent) 22%, transparent), rgba(230,62,109,0) 60%),
        radial-gradient(60% 50% at 100% 100%, rgba(230,62,109,.10), color-mix(in srgb, var(--accent) 0%, transparent) 60%);
      mix-blend-mode: screen; opacity: .55;
    }

    .card {
      width: 100%;
      max-width: 1120px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px 26px 30px;
      position: relative;
      overflow: hidden;
    }
    /* 轻噪点纹理（略降亮度以配合红系） */
    .card::after {
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 10 10'%3E%3Ccircle cx='1' cy='1' r='.5' fill='%23fff' opacity='.025'/%3E%3C/svg%3E");
      filter: opacity(.35);
      border-radius: var(--radius);
    }

    .header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; margin-bottom: 18px;
    }
    .title { font-size: 28px; font-weight: 800; letter-spacing: .3px; color: var(--text); }
    .sub { color: var(--sub); font-size: 16px; opacity: .95; margin-top: 4px; }
    .pill {
      padding: 10px 14px; border-radius: 999px; font-weight: 700;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid #5a4242; color: #fdeaea; font-size: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 6px 16px rgba(0,0,0,.28);
    }

    .boss-wrap {
      background: #342727;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      position: relative;
    }
    .boss {
      width: 100%;
      display: grid; place-items: center;
      border: 1px dashed #6b4d4d;
      border-radius: 12px;
      background: #2f2424;
      padding: 14px;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .banner {
      position: absolute;
      left: 50%; top: 14px;
      transform: translateX(-50%) translateY(-20px);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 86%, #ff9090), color-mix(in srgb, var(--accent) 86%, #d43a5f));
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      box-shadow: 0 10px 22px color-mix(in srgb, var(--accent) 45%, rgba(0,0,0,.0));
      border: 1px solid rgba(255,255,255,.22);
      font-weight: 900; letter-spacing: .6px; font-size: 16px;
      opacity: 0; pointer-events: none; z-index: 6;
    }
    .banner.show { animation: bannerIn .55s cubic-bezier(.2,.7,.2,1) forwards; }
    @keyframes bannerIn {
      0% { transform: translateX(-50%) translateY(-20px) scale(.94); opacity: 0; }
      60% { transform: translateX(-50%) translateY(0) scale(1.04); opacity: 1; }
      100% { transform: translateX(-50%) translateY(0) scale(1); opacity: 1; }
    }

    .boss-frame {
      width: 800px; height: 1200px; max-width: 100%;
      aspect-ratio: 2 / 3;
      border-radius: 12px;
      overflow: hidden;
      display: grid; place-items: center;
      background: linear-gradient(180deg, #3a2a2a, #2f2424);
      border: 1px solid #6b4d4d;
      position: relative;
      perspective: 1200px;
      transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      box-shadow:
        0 18px 50px rgba(0,0,0,.45),
        inset 0 10px 38px color-mix(in srgb, var(--accent) 16%, transparent),
        inset 0 -10px 38px color-mix(in srgb, #ff6b8f 16%, transparent);
    }
    .boss-frame:hover {
      transform: translateY(-2px) rotateX(1deg);
      box-shadow:
        0 22px 64px rgba(0,0,0,.55),
        inset 0 12px 44px color-mix(in srgb, var(--accent) 18%, transparent),
        inset 0 -12px 44px color-mix(in srgb, #ff6b8f 18%, transparent);
    }

    /* 已移除右上角名称角标 */

    .boss-bg {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      z-index: 1;
      transform: translateZ(-30px) scale(1.04);
    }
    .boss-bg img {
      width: 100%; height: 100%;
      object-fit: cover;
      filter: saturate(1.02) contrast(1.02) brightness(.96);
      transform: scale(1.02);
    }

    .boss-char {
      position: absolute; inset: 0; z-index: 3;
      display: grid; place-items: center;
      transform: translateZ(30px);
    }
    .boss-char img {
      width: 100%; height: 100%;
      object-fit: contain;
      transform-origin: 50% 55%;
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.55));
      will-change: transform, filter, opacity;
      transition: opacity .45s ease;
    }

    /* 人物边缘光：改为红系与暖白混合 */
    .boss-char::after {
      content: "";
      position: absolute; inset: 0;
      z-index: 3; pointer-events: none;
      background:
        radial-gradient(60% 60% at 20% 20%, color-mix(in srgb, var(--accent) 28%, transparent), rgba(0,0,0,0) 60%),
        radial-gradient(55% 55% at 80% 30%, rgba(255,120,150,.24), rgba(0,0,0,0) 62%),
        radial-gradient(70% 70% at 50% 90%, rgba(255,240,240,.12), rgba(0,0,0,0) 70%);
      mix-blend-mode: screen;
      opacity: .85;
      filter: blur(16px);
      animation: rimDrift 6.2s ease-in-out 1.2s infinite;
    }
    @keyframes rimDrift {
      0%   { transform: translate(0,0) scale(1); opacity: .8; }
      50%  { transform: translate(2px,-3px) scale(1.02); opacity: .95; }
      100% { transform: translate(0,0) scale(1); opacity: .8; }
    }

    .boss-frame.entering .boss-char img {
      animation: bossEnter .85s cubic-bezier(.18,.9,.2,1.05) both, bossBreath 5.4s ease-in-out 1s infinite;
    }
    .boss-frame:not(.entering) .boss-char img {
      animation: bossBreath 5.4s ease-in-out infinite;
    }
    @keyframes bossEnter {
      0%   { transform: translateY(30px) scale(.86); filter: drop-shadow(0 6px 10px rgba(0,0,0,.50)) brightness(.98); opacity: 0; }
      40%  { transform: translateY(-6px) scale(1.04); opacity: 1; }
      70%  { transform: translateY(0) scale(1); }
      100% { transform: translateY(0) scale(1); filter: drop-shadow(0 8px 10px rgba(0,0,0,.55)) brightness(1); }
    }
    @keyframes bossBreath {
      0%   { transform: translateY(0px) scale(1) rotate(0deg); filter: drop-shadow(0 8px 10px rgba(0,0,0,.55)) brightness(1); }
      25%  { transform: translateY(-6px) scale(1.012) rotate(-.15deg); filter: drop-shadow(0 10px 12px rgba(0,0,0,.58)) brightness(1.02); }
      50%  { transform: translateY(0px) scale(1.004) rotate(0deg); }
      75%  { transform: translateY(6px) scale(0.996) rotate(.15deg); filter: drop-shadow(0 7px 9px rgba(0,0,0,.50)) brightness(.995); }
      100% { transform: translateY(0px) scale(1) rotate(0deg); }
    }

    /* 地面影子边缘更清晰、对比更高 */
    .char-shadow {
      position: absolute; left: 50%; bottom: 14px; transform: translateX(-50%);
      width: 50%; height: 18px; border-radius: 50%;
      background: radial-gradient(closest-side, rgba(0,0,0,.60), rgba(0,0,0,0));
      filter: blur(9px);
      opacity: .9;
      z-index: 2;
      animation: shadowPulse 5.4s ease-in-out infinite;
    }
    @keyframes shadowPulse {
      0%   { transform: translateX(-50%) scaleX(1.00); opacity: .9; filter: blur(9px); }
      25%  { transform: translateX(-50%) scaleX(1.05); opacity: .95; filter: blur(8px); }
      50%  { transform: translateX(-50%) scaleX(1.00); opacity: .9; filter: blur(9px); }
      75%  { transform: translateX(-50%) scaleX(0.95); opacity: .84; filter: blur(10px); }
      100% { transform: translateX(-50%) scaleX(1.00); opacity: .9; filter: blur(9px); }
    }

    .entry-glow { position: absolute; inset: -20% -10%; background: conic-gradient(from 220deg at 50% 50%, rgba(255,255,255,.0), color-mix(in srgb, var(--accent) 30%, transparent), rgba(255,130,150,.26), rgba(255,255,255,0)); mix-blend-mode: screen; filter: blur(18px); opacity: 0; pointer-events: none; z-index: 5; }
    .entry-glow.show { animation: glowSweep .9s ease-out forwards; }
    @keyframes glowSweep {
      0% { transform: translateX(-12%) rotate(-6deg); opacity: 0; }
      30% { opacity: .75; }
      100% { transform: translateX(12%) rotate(6deg); opacity: 0; }
    }

    .ground-shadow {
      position: absolute; left: 50%; bottom: 10px; transform: translateX(-50%);
      width: 46%; height: 16px; border-radius: 50%;
      background: radial-gradient(closest-side, rgba(0,0,0,.50), rgba(0,0,0,0));
      filter: blur(9px);
      opacity: .0; pointer-events: none; z-index: 2;
    }
    .ground-shadow.show { animation: groundIn .9s ease-out forwards; }
    @keyframes groundIn {
      0%   { transform: translateX(-50%) scaleX(.6); opacity: 0; }
      60%  { transform: translateX(-50%) scaleX(1.08); opacity: .98; }
      100% { transform: translateX(-50%) scaleX(1); opacity: .95; }
    }

    /* 常驻暗角与闲置扫光（调为红系） */
    .boss-frame::before {
      content: ""; position: absolute; inset: 0; z-index: 2; pointer-events: none;
      background: radial-gradient(120% 80% at 50% 110%, rgba(0,0,0,.55), rgba(0,0,0,0) 56%);
      mix-blend-mode: multiply; opacity: .85;
    }
    .boss-frame::after {
      content: ""; position: absolute; inset: -30% -40%; z-index: 4; pointer-events: none;
      background: conic-gradient(from 220deg at 50% 50%, rgba(255,255,255,0), color-mix(in srgb, var(--accent) 22%, transparent) 15%, rgba(255,120,150,.22) 35%, rgba(255,255,255,0) 60%);
      filter: blur(24px); opacity: .0;
      animation: idleSweep 7.5s ease-in-out 1.6s infinite;
    }
    @keyframes idleSweep {
      0%, 10% { opacity: 0; transform: translateX(-12%) rotate(-6deg); }
      22% { opacity: .38; }
      40% { opacity: 0; transform: translateX(12%) rotate(6deg); }
      100% { opacity: 0; }
    }

    .bossFrame-hit { animation: bossHit .24s cubic-bezier(.2,.8,.2,1); }
    @keyframes bossHit {
      0%   { transform: translate(0,0) scale(1); }
      25%  { transform: translate(-3px, 2px) scale(1.006); }
      50%  { transform: translate(3px, -2px) scale(1.004); }
      75%  { transform: translate(-2px, 2px) scale(1.002); }
      100% { transform: translate(0,0) scale(1); }
    }
    .bossHit-flash::after {
      content: ""; position: absolute; inset: 0; z-index: 6;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.55), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 52% 48%, color-mix(in srgb, var(--accent) 22%, transparent), rgba(230,62,109,0) 40%);
      mix-blend-mode: screen; opacity: 0; animation: hitFlashWhite .18s ease;
      pointer-events: none;
    }
    @keyframes hitFlashWhite { 0% { opacity: .95; } 100% { opacity: 0; } }

    .boss-frame.defeated .boss-char img { opacity: 0; }
    .kill-wave { position: absolute; inset: 0; margin: auto; pointer-events: none; border-radius: 50%; background: radial-gradient(closest-side, color-mix(in srgb, var(--accent) 45%, transparent), color-mix(in srgb, var(--accent) 28%, transparent) 45%, rgba(0,0,0,0) 70%); transform: scale(0.2); opacity: 0; animation: waveOut .6s ease-out forwards; z-index: 6; }
    @keyframes waveOut { 0% { transform: scale(0.2); opacity: .0; } 20% { opacity: .95; } 100% { transform: scale(2.2); opacity: 0; } }

    /* 粒子：改为红系光粒 */
    .particles { position: absolute; inset: 0; pointer-events: none; z-index: 6; }
    .particles span {
      position: absolute; width: 6px; height: 6px; border-radius: 50%;
      background: radial-gradient(circle, color-mix(in srgb, var(--accent) 70%, #ffa0b3), color-mix(in srgb, var(--accent) 85%, #d44b4b) 60%, rgba(0,0,0,0));
      box-shadow: 0 0 10px color-mix(in srgb, var(--accent) 75%, rgba(0,0,0,0)), 0 0 18px rgba(255,120,150,.35);
      opacity: 0; transform: translate(0,0) scale(.8);
      animation: particleOut .75s cubic-bezier(.2,.8,.2,1) forwards;
      filter: drop-shadow(0 0 12px color-mix(in srgb, var(--accent) 65%, rgba(0,0,0,0)));
    }
    .particles span::after {
      content: ""; position: absolute; left: 50%; top: 50%; width: 140%; height: 1px; transform: translate(-50%,-50%) rotate(var(--trail-rot, 0deg));
      background: linear-gradient(90deg, rgba(230,62,109,0), color-mix(in srgb, var(--accent) 55%, rgba(0,0,0,0)), rgba(230,62,109,0));
      opacity: .85;
    }
    @keyframes particleOut {
      0%   { opacity: 0; transform: translate(0,0) scale(.8); }
      12%  { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--dx), var(--dy)) scale(0.24) rotate(6deg); }
    }

    /* 背景微尘粒子（常驻） */
    .dust { position: absolute; inset: 0; pointer-events: none; z-index: 2; mix-blend-mode: screen; }
    .dust i {
      position: absolute; width: 2px; height: 2px; border-radius: 50%;
      background: color-mix(in srgb, var(--accent) 22%, #fff0);
      box-shadow: 0 0 6px color-mix(in srgb, var(--accent) 35%, rgba(0,0,0,.0));
      animation: dustDrift var(--t,12s) ease-in-out var(--d,0s) infinite alternate;
      opacity: .6;
    }
    @keyframes dustDrift {
      0% { transform: translate(0,0) scale(.9); opacity: .35; }
      50% { transform: translate(12px, -8px) scale(1.1); opacity: .6; }
      100% { transform: translate(-8px, 10px) scale(1); opacity: .4; }
    }

    .hp-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-top: 16px; }
    .hp { background: #3a2a2a; border: 1px solid #6b4d4d; border-radius: 12px; width: 128px; height: 128px; max-width: 100%; display: grid; place-items: center; position: relative; overflow: hidden; margin-inline: auto; box-shadow: 0 16px 24px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05); }
    .hp img { width: 100%; height: 100%; object-fit: contain; transition: transform .25s ease; padding: 8px; }
    .hp.alive:hover { transform: translateY(-2px); transition: transform .18s ease; }
    .hp.alive:hover img { transform: scale(1.06); }
    .hp.destroying { animation: hitFlash .12s ease-in-out 2; }
    @keyframes hitFlash { 0%, 100% { filter: none; } 50% { filter: brightness(1.25) saturate(1.1); } }
    .hp.destroying img { animation: shatter .6s cubic-bezier(.2,.7,.2,1) forwards; transform-origin: 60% 40%; }
    @keyframes shatter {
      0%   { transform: scale(1) rotate(0deg); opacity: 1; filter: none; }
      24%  { transform: scale(1.08) rotate(-6deg) translate(0, -2px); }
      52%  { transform: scale(0.94) rotate(10deg) translate(8px, -10px); filter: saturate(1.12) brightness(1.05); }
      70%  { transform: scale(0.74) rotate(14deg) translate(16px, -18px); }
      100% { transform: scale(0.58) rotate(18deg) translate(24px, -26px); opacity: 0; filter: blur(1px); }
    }
    .hp.dead { opacity: .28; filter: grayscale(.6) contrast(.95); }

    .controls { display: flex; align-items: center; gap: 14px; margin-top: 18px; flex-wrap: wrap; }

    /* 按钮：改为更暗的红棕按钮底，悬停提亮 */
    .btn {
      --btn-bg: linear-gradient(180deg, #2b2222, #251c1c);
      --btn-br: #3a2a2a;
      --btn-txt: #fff3f3;
      appearance: none; border: 1px solid var(--btn-br); background: var(--btn-bg); color: var(--btn-txt);
      padding: 13px 18px; border-radius: 12px; font-weight: 800; letter-spacing: .4px; font-size: 16px; cursor: pointer; user-select: none; transform: translateZ(0);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 12px 22px rgba(0,0,0,.45);
      transition: transform .12s ease, filter .2s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      display: inline-flex; align-items: center; gap: 10px; position: relative; overflow: hidden;
    }
    .btn:hover { transform: translateY(-1px) scale(1.01); filter: brightness(1.06) saturate(1.04); border-color: #5a4040; background: linear-gradient(180deg, #342828, #2b2222); }
    .btn:active { transform: translateY(0) scale(.99); filter: brightness(.96); }
    .btn::after { content: ""; position: absolute; inset: -60% -10%; transform: translateX(-120%) rotate(12deg); background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.18) 30%, rgba(255,255,255,0)); transition: transform .5s ease; }
    .btn:hover::after { transform: translateX(120%) rotate(12deg); }

    .icon { width: 18px; height: 18px; position: relative; display: inline-block; }

    .flash { animation: flash .5s ease; }
    @keyframes flash { 0% { filter: brightness(1.1) saturate(1.05); } 100% { filter: none; } }

    .gyro-controls { display: none; align-items: center; gap: 10px; }
    .gyro-controls .state { font-size: 12px; color: var(--sub); }
    @media (hover: none) and (pointer: coarse) {
      .gyro-controls { display: inline-flex; }
    }

    @media (max-width: 980px) {
      .title { font-size: 24px; }
      .sub { font-size: 14px; }
      .boss-frame { width: 100%; height: auto; }
      .hp { width: 100%; height: auto; aspect-ratio: 1 / 1; }
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="header">
      <div>
        <div class="title">hearts A</div>
        <div class="sub">敌人阶段：回复一点生命</div>
      </div>
      <span class="pill" id="hpCounter">HP 5 / 5</span>
    </div>

    <section class="boss-wrap">
      <div class="boss" id="boss">
        <div class="banner" id="banner">hearts_A 被击败！</div>

        <div class="boss-frame entering" id="bossFrame">
          <!-- 背景 -->
          <div class="boss-bg">
            <img src="assets/boss_bg.png" alt="背景">
          </div>

          <!-- 人物（呼吸 + 投影 + 边缘光） -->
          <div class="boss-char">
            <img id="bossCharImg" src="assets/boss_char.png" alt="人物">
          </div>
          <div class="char-shadow"></div>

          <!-- 入场扫光与地影 -->
          <div class="entry-glow" id="entryGlow"></div>
          <div class="ground-shadow" id="groundShadow"></div>

          <!-- 前景粒子 -->
          <div class="particles" id="particles"></div>
          <!-- 背景微尘粒子 -->
          <div class="dust" id="dust"></div>
        </div>
      </div>

      <div class="hp-row" id="hpRow">
        <div class="hp alive"><img src="assets/hp1.png" alt="HP 1"></div>
        <div class="hp alive"><img src="assets/hp2.png" alt="HP 2"></div>
        <div class="hp alive"><img src="assets/hp3.png" alt="HP 3"></div>
        <div class="hp alive"><img src="assets/hp4.png" alt="HP 4"></div>
        <div class="hp alive"><img src="assets/hp5.png" alt="HP 5"></div>
      </div>

      <div class="controls">
        <button class="btn" id="resetBtn" title="重置血量">重置</button>
      </div>

      <audio id="bgm" src="assets/demo.mp3" preload="auto" loop></audio>
      <audio id="sfxHit" src="assets/hit.mp3" preload="auto"></audio>
      <audio id="sfxDefeat" src="assets/defeat.mp3" preload="auto"></audio>
    </section>
  </main>

  <script>
    // 元素
    const hpRow = document.getElementById('hpRow');
    const resetBtn = document.getElementById('resetBtn');

    const hpCounter = document.getElementById('hpCounter');
    const bgm = document.getElementById('bgm');

    const bossFrame = document.getElementById('bossFrame');
    const banner = document.getElementById('banner');
    const entryGlow = document.getElementById('entryGlow');
    const groundShadow = document.getElementById('groundShadow');
    const particles = document.getElementById('particles');
    const dust = document.getElementById('dust');

    const gyroToggleBtn = document.getElementById('gyroToggleBtn');
    const gyroCalibBtn = document.getElementById('gyroCalibBtn');
    const gyroState = document.getElementById('gyroState');

    let currentHP = 5;
    const maxHP = 5;
    let sfxOn = true; // 始终开启音效

    // 自动播放：首次用户交互触发
    let triedAutoPlay = false;
    function ensureAutoPlay() {
      if (triedAutoPlay) return;
      triedAutoPlay = true;
      bgm.volume = 1;
      bgm.play().catch(() => { triedAutoPlay = false; });
    }
    ['click', 'touchend', 'pointerdown', 'keydown'].forEach(evt =>
      window.addEventListener(evt, ensureAutoPlay, { once: true, passive: true })
    );

    function updateHpCounter() {
      hpCounter.textContent = `HP ${currentHP} / ${maxHP}`;
      hpCounter.classList.remove('flash');
      requestAnimationFrame(() => hpCounter.classList.add('flash'));
    }

    function playEntryAnimation() {
      entryGlow.classList.add('show');
      groundShadow.classList.add('show');
      requestAnimationFrame(() => {
        setTimeout(() => bossFrame.classList.remove('entering'), 1100);
      });
    }

    function vibrate(pattern) {
      if (navigator.vibrate) { try { navigator.vibrate(pattern); } catch(e) {} }
    }

    function duckBgm(to = 0.4, dur = 160) {
      try {
        const start = (typeof bgm.volume === 'number') ? bgm.volume : 1;
        const end = to;
        const t0 = performance.now();
        function step(t) {
          const k = Math.min(1, (t - t0) / dur);
          bgm.volume = start + (end - start) * k;
          if (k < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
        setTimeout(() => {
          const t1 = performance.now(); const v0 = bgm.volume;
          function restore(t) {
            const k = Math.min(1, (t - t1) / 420);
            bgm.volume = v0 + (1 - v0) * k;
            if (k < 1) requestAnimationFrame(restore);
          }
          requestAnimationFrame(restore);
        }, dur + 120);
      } catch (e) {}
    }

    function bossHitFeedback() {
      bossFrame.classList.remove('bossFrame-hit');
      void bossFrame.offsetWidth;
      bossFrame.classList.add('bossFrame-hit');

      bossFrame.classList.add('bossHit-flash');
      setTimeout(() => bossFrame.classList.remove('bossHit-flash'), 180);

      if (sfxOn) { try { sfxHit.currentTime = 0; sfxHit.play(); } catch(e) {} }
      if (!bgm.paused) duckBgm(0.55, 120);
      vibrate(20);
    }

    // 前景击败粒子
    function spawnDefeatParticles(count = 46) {
      const rect = bossFrame.getBoundingClientRect();
      const cx = rect.width / 2;
      const cy = rect.height / 2;
      for (let i = 0; i < count; i++) {
        const p = document.createElement('span');
        const angle = Math.random() * Math.PI * 2;
        const dist = 90 + Math.random() * 260;
        const dx = Math.cos(angle) * dist;
        const dy = Math.sin(angle) * dist * 0.85;
        const size = 3 + Math.random() * 9;
        const hue = 10 + Math.random() * 20; // 红橙带
        p.style.left = cx + 'px';
        p.style.top = cy + 'px';
        p.style.setProperty('--dx', dx + 'px');
        p.style.setProperty('--dy', dy + 'px');
        p.style.setProperty('--trail-rot', (angle * 180 / Math.PI) + 'deg');
        p.style.width = p.style.height = size + 'px';
        p.style.animationDuration = (0.6 + Math.random() * 0.4) + 's';
        p.style.background = `radial-gradient(circle, hsl(${hue} 80% 65%), hsl(${hue} 70% 52%) 60%, rgba(0,0,0,0))`;
        particles.appendChild(p);
        p.addEventListener('animationend', () => p.remove(), { once: true });
      }
    }

    function triggerDefeatFX() {
      banner.classList.add('show');
      bossFrame.classList.add('defeated');

      const wave = document.createElement('div');
      wave.className = 'kill-wave';
      bossFrame.appendChild(wave);
      wave.addEventListener('animationend', () => wave.remove(), { once: true });

      spawnDefeatParticles(58);
      const smoke = document.createElement('div');
      smoke.className = 'smoke';
      bossFrame.appendChild(smoke);
      smoke.addEventListener('animationend', () => smoke.remove(), { once: true });

      vibrate([60, 40, 60]);
      try { sfxDefeat.currentTime = 0; sfxDefeat.play(); } catch(e) {}
      if (!bgm.paused) duckBgm(0.25, 220);
    }

    function resetDefeatFX() {
      banner.classList.remove('show');
      bossFrame.classList.remove('defeated');
    }

    // 攻击逻辑（点击屏幕任意位置）
    function destroyOneHP() {
      const target = hpRow.querySelector('.hp.alive');
      if (!target) return;

      bossHitFeedback();

      const delay = Math.random() * 60; // 轻微错峰
      setTimeout(() => {
        target.classList.remove('alive');
        target.classList.add('destroying');
        target.addEventListener('animationend', (e) => {
          if (e.animationName === 'shatter') {
            target.classList.remove('destroying');
            target.classList.add('dead');
          }
        }, { once: true });

        currentHP = Math.max(0, currentHP - 1);
        updateHpCounter();

        if (currentHP <= 0) {
          triggerDefeatFX();
        }
      }, delay);
    }

    function resetHP() {
      const all = hpRow.querySelectorAll('.hp');
      all.forEach(el => {
        el.classList.remove('dead', 'destroying');
        if (!el.classList.contains('alive')) el.classList.add('alive');
      });
      currentHP = maxHP;
      updateHpCounter();
      resetBtn.classList.remove('flash');
      requestAnimationFrame(() => resetBtn.classList.add('flash'));
      resetDefeatFX();
    }

    // 3D 视差与陀螺仪
    let parallaxRAF = 0;
    function applyParallax(nx, ny) {
      cancelAnimationFrame(parallaxRAF);
      parallaxRAF = requestAnimationFrame(() => {
        bossFrame.style.transform = `rotateX(${(-ny*8).toFixed(2)}deg) rotateY(${(nx*8).toFixed(2)}deg) translateY(-1px)`;
        const bg = bossFrame.querySelector('.boss-bg');
        const ch = bossFrame.querySelector('.boss-char');
        bg.style.transform = `translateZ(-30px) translate(${(-nx*20).toFixed(1)}px, ${(ny*20).toFixed(1)}px) scale(1.04)`;
        ch.style.transform = `translateZ(30px) translate(${(nx*8).toFixed(1)}px, ${(-ny*8).toFixed(1)}px)`;
      });
    }
    function parallaxMouse(e) {
      const r = bossFrame.getBoundingClientRect();
      const x = (e.clientX - (r.left + r.width/2)) / r.width;  // -0.5..0.5
      const y = (e.clientY - (r.top + r.height/2)) / r.height;
      applyParallax(x, y);
    }

    let gyroEnabled = false;
    let gyroCalib = { beta0: 0, gamma0: 0 };
    async function enableGyro() {
      if (!('DeviceOrientationEvent' in window)) {
        if (gyroState) gyroState.textContent = '不支持';
        return false;
      }
      if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const resp = await DeviceOrientationEvent.requestPermission();
          if (resp !== 'granted') { if (gyroState) gyroState.textContent = '权限被拒'; return false; }
        } catch (e) { if (gyroState) gyroState.textContent = '权限失败'; return false; }
      }
      window.addEventListener('deviceorientation', handleDeviceOrientation);
      gyroEnabled = true;
      if (gyroState) gyroState.textContent = '已启用';
      if (gyroToggleBtn) gyroToggleBtn.textContent = '陀螺仪 关';
      gyroCalib = { beta0: 0, gamma0: 0 };
      return true;
    }
    function disableGyro() {
      window.removeEventListener('deviceorientation', handleDeviceOrientation);
      gyroEnabled = false;
      if (gyroState) gyroState.textContent = '未启用';
      if (gyroToggleBtn) gyroToggleBtn.textContent = '陀螺仪 开';
      bossFrame.style.transform = '';
      const bg = bossFrame.querySelector('.boss-bg');
      const ch = bossFrame.querySelector('.boss-char');
      bg.style.transform = 'translateZ(-30px) scale(1.04)';
      ch.style.transform = 'translateZ(30px)';
    }
    function handleDeviceOrientation(e) {
      if (!gyroEnabled) return;
      let { beta, gamma } = e;
      if (beta == null || gamma == null) return;
      beta -= gyroCalib.beta0;
      gamma -= gyroCalib.gamma0;
      const nx = Math.max(-0.5, Math.min(0.5, gamma / 45)); // 左右
      const ny = Math.max(-0.5, Math.min(0.5, beta / 60));  // 前后
      applyParallax(nx, ny);
    }
    function calibrateGyroOnce(e) {
      if (e && typeof e.beta === 'number' && typeof e.gamma === 'number') {
        gyroCalib.beta0 = e.beta;
        gyroCalib.gamma0 = e.gamma;
        if (gyroState) {
          gyroState.textContent = '已校准';
          setTimeout(() => gyroState.textContent = '已启用', 1000);
        }
      }
    }

    // 背景微尘粒子生成
    function spawnDust(n = 36) {
      const r = bossFrame.getBoundingClientRect();
      for (let i = 0; i < n; i++) {
        const d = document.createElement('i');
        const x = Math.random() * r.width;
        const y = Math.random() * r.height;
        d.style.left = x + 'px';
        d.style.top = y + 'px';
        d.style.setProperty('--t', (10 + Math.random() * 10) + 's');
        d.style.setProperty('--d', (Math.random() * 5) + 's');
        dust.appendChild(d);
      }
    }

    // 事件：点击屏幕攻击（排除按钮点按）
    function onGlobalAttack(e) {
      const target = e.target;
      if (target.closest && target.closest('.btn')) return;
      destroyOneHP();
    }

    // 统一使用 pointer 事件，避免 touch + click 双触发
    window.addEventListener('pointerdown', onGlobalAttack, { passive: true });

    // 其他事件
    resetBtn.addEventListener('click', resetHP);

    // 鼠标视差（桌面端）
    bossFrame.addEventListener('mousemove', parallaxMouse);
    bossFrame.addEventListener('mouseleave', () => {
      bossFrame.style.transform = '';
      const bg = bossFrame.querySelector('.boss-bg');
      const ch = bossFrame.querySelector('.boss-char');
      bg.style.transform = 'translateZ(-30px) scale(1.04)';
      ch.style.transform = 'translateZ(30px)';
    });

    // 陀螺仪按钮（容错：若页面无按钮则跳过）
    if (document.getElementById('gyroToggleBtn')) {
      gyroToggleBtn.addEventListener('click', async () => {
        if (gyroEnabled) disableGyro();
        else {
          const ok = await enableGyro();
          if (ok) {
            const once = (ev) => { calibrateGyroOnce(ev); window.removeEventListener('deviceorientation', once); };
            window.addEventListener('deviceorientation', once);
          }
        }
      });
    }
    if (document.getElementById('gyroCalibBtn')) {
      gyroCalibBtn.addEventListener('click', () => {
        const once = (ev) => { calibrateGyroOnce(ev); window.removeEventListener('deviceorientation', once); };
        window.addEventListener('deviceorientation', once);
        if (gyroState) gyroState.textContent = '等待校准...';
      });
    }

    // 初始化
    updateHpCounter();
    if (document.readyState === 'complete') {
      playEntryAnimation();
    } else {
      window.addEventListener('load', playEntryAnimation, { once: true });
    }
    // 生成背景微尘
    spawnDust(42);
  </script>
</body>
</html>